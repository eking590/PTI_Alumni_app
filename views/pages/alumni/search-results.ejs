<%- include('../../partials/header') %>

<div class="container mx-auto px-4 py-8 max-w-6xl">
  <h2 class="text-2xl font-bold mb-6">
    <% if (searchByImage) { %>
      Image Search Results
    <% } else { %>
      <% if (typeof query !== 'undefined' && query) { %>
        Search Results for "<%= query %>"
      <% } else { %>
        Search Results
      <% } %>
    <% } %>
  </h2>

  <!-- Image Search Results Header -->
  <% if (searchByImage && typeof localResults !== 'undefined' && localResults.length === 0) { %>
    <div class="bg-yellow-50 p-6 rounded-lg border border-yellow-200 mb-6">
      <h3 class="text-lg font-semibold text-yellow-800 mb-2">Image Search Results</h3>
      <p class="text-yellow-700">
        No similar images found in our database. Try with a different image or use text search.
      </p>
      <div class="mt-3">
        <a href="/alumni/search-form" class="text-blue-600 hover:text-blue-800 font-medium">
          ← Back to search
        </a>
      </div>
    </div>
  <% } %>

  <% if (searchByImage && typeof localResults !== 'undefined' && localResults.length > 0) { %>
    <div class="bg-green-50 p-4 rounded-lg border border-green-200 mb-6">
      <p class="text-green-700 font-medium">
        Found <%= localResults.length %> similar image(s) with similarity scores:
      </p>
      <div class="mt-2 space-y-1">
        <% localResults.forEach((alum, index) => { %>
          <p class="text-sm text-green-600">
            <%= alum.firstName %> <%= alum.lastName %>: 
            <span class="font-semibold"><%= (alum.similarityScore * 100).toFixed(1) %>% similar</span>
          </p>
        <% }); %>
      </div>
    </div>
  <% } %>

  <!-- Statistics Cards -->
  <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
    <div class="bg-white p-4 rounded-lg shadow text-center">
      <h3 class="text-sm font-semibold text-gray-600">Total Results</h3>
      <p class="text-2xl font-bold"><%= typeof totalResults !== 'undefined' ? totalResults : 0 %></p>
    </div>
    <div class="bg-white p-4 rounded-lg shadow text-center">
      <h3 class="text-sm font-semibold text-gray-600">Results with Images</h3>
      <p class="text-2xl font-bold"><%= typeof resultsWithImages !== 'undefined' ? resultsWithImages : 0 %></p>
      <p class="text-sm text-gray-500">
        (<%= Math.round(((typeof resultsWithImages !== 'undefined' ? resultsWithImages : 0) / (typeof totalResults !== 'undefined' && totalResults > 0 ? totalResults : 1)) * 100) %>%)
      </p>
    </div>
    <div class="bg-white p-4 rounded-lg shadow text-center">
      <h3 class="text-sm font-semibold text-gray-600">Image Coverage</h3>
      <div class="w-full bg-gray-200 rounded-full h-2 mt-2">
        <div class="bg-blue-600 h-2 rounded-full" 
             style="width: <%= Math.round(((typeof resultsWithImages !== 'undefined' ? resultsWithImages : 0) / (typeof totalResults !== 'undefined' && totalResults > 0 ? totalResults : 1)) * 100) %>%"></div>
      </div>
    </div>
  </div>

  <!-- Error Message for Image Search -->
  <% if (typeof error !== 'undefined' && error) { %>
    <div class="bg-red-50 p-4 rounded-lg border border-red-200 mb-6">
      <h3 class="text-lg font-semibold text-red-800 mb-2">Search Error</h3>
      <p class="text-red-700"><%= error %></p>
      <div class="mt-2">
        <a href="/alumni/search-form" class="text-blue-600 hover:text-blue-800 font-medium">
          ← Try again
        </a>
      </div>
    </div>
  <% } %>

  <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
    <!-- Local Database Results -->
    <div class="bg-white p-6 rounded-lg shadow">
      <h3 class="text-xl font-semibold mb-4 border-b pb-2">
        Alumni Matches 
        <span class="text-sm font-normal text-gray-500">(<%= typeof localResults !== 'undefined' ? localResults.length : 0 %> found)</span>
      </h3>
      
      <% if (typeof localResults !== 'undefined' && localResults.length > 0) { %>
        <div class="space-y-4">
          <% localResults.forEach(alum => { %>
            <div class="border rounded-lg p-4 hover:shadow-md transition-shadow">
              <div class="flex items-start space-x-4">
                <!-- Profile Image -->
                <% if (alum.image) { %>
                  <img src="<%= alum.image %>" 
                       alt="<%= alum.firstName %> <%= alum.lastName %>" 
                       class="w-16 h-16 rounded-full object-cover border-2 border-gray-200"
                       onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                  <div class="w-16 h-16 rounded-full bg-gray-200 flex items-center justify-center text-xl font-bold text-gray-600 hidden">
                    <%= alum.firstName.charAt(0) %><%= alum.lastName.charAt(0) %>
                  </div>
                <% } else { %>
                  <div class="w-16 h-16 rounded-full bg-gray-200 flex items-center justify-center text-xl font-bold text-gray-600">
                    <%= alum.firstName.charAt(0) %><%= alum.lastName.charAt(0) %>
                  </div>
                <% } %>

                <div class="flex-1">
                  <h4 class="font-semibold text-lg">
                    <%= alum.firstName %> <%= alum.lastName %>
                    <% if (alum.graduationYear) { %>
                      <span class="text-gray-500 text-sm">(<%= new Date(alum.graduationYear).getFullYear() %>)</span>
                    <% } %>
                    <% if (alum.similarityScore) { %>
                      <span class="text-green-600 text-sm font-medium">
                        (<%= (alum.similarityScore * 100).toFixed(1) %>% match)
                      </span>
                    <% } %>
                  </h4>
                  
                  <% if (alum.company || alum.currentPosition) { %>
                    <p class="text-gray-600 text-sm mt-1">
                      <% if (alum.currentPosition) { %><%= alum.currentPosition %><% } %>
                      <% if (alum.company) { %> at <span class="font-medium"><%= alum.company %></span><% } %>
                    </p>
                  <% } %>

                  <% if (alum.department || alum.degree) { %>
                    <p class="text-gray-500 text-xs mt-1">
                      <% if (alum.degree) { %><%= alum.degree %><% } %>
                      <% if (alum.department) { %> in <%= alum.department %><% } %>
                    </p>
                  <% } %>

                  <% if (alum.achievements && alum.achievements.length > 0) { %>
                    <div class="mt-2">
                      <p class="text-xs text-gray-500">Skills/Achievements:</p>
                      <div class="flex flex-wrap gap-1 mt-1">
                        <% alum.achievements.slice(0, 3).forEach(achievement => { %>
                          <span class="bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded">
                            <%= achievement %>
                          </span>
                        <% }); %>
                        <% if (alum.achievements.length > 3) { %>
                          <span class="text-gray-400 text-xs">+<%= alum.achievements.length - 3 %> more</span>
                        <% } %>
                      </div>
                    </div>
                  <% } %>
                </div>
              </div>
            </div>
          <% }); %>
        </div>
      <% } else if (!searchByImage) { %>
        <p class="text-gray-500 text-center py-8">No alumni found matching your criteria.</p>
      <% } %>
    </div>

    <!-- AI Insights & Analysis -->
    <div class="space-y-6">
      <!-- Mistral API Results -->
      <% if (!searchByImage || (typeof localResults !== 'undefined' && localResults.length > 0)) { %>
        <div class="bg-white p-6 rounded-lg shadow">
          <h3 class="text-xl font-semibold mb-4 border-b pb-2">AI Search Insights</h3>
          
          <% 
            let mistralContent = '';
            if (typeof apiResults !== 'undefined' && apiResults.choices && apiResults.choices.length > 0) {
              mistralContent = apiResults.choices[0].message.content;
              
              mistralContent = mistralContent
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                .replace(/\n\n/g, '</p><p>')
                .replace(/\n/g, '<br>');
            }
          %>
          
          <% if (mistralContent) { %>
            <div class="prose max-w-none text-gray-700">
              <p><%- mistralContent %></p>
            </div>
          <% } else { %>
            <p class="text-gray-500">No suggestions available from the AI.</p>
          <% } %>

          <div class="mt-4 p-3 bg-blue-50 rounded text-sm text-blue-800">
            <strong>Note:</strong> These insights are generated by AI based on your search criteria and database results.
          </div>
        </div>
      <% } %>

      <!-- Image Analysis -->
      <% if (typeof hasImages !== 'undefined' && hasImages && typeof imageAnalysis !== 'undefined' && imageAnalysis && (!searchByImage || (typeof localResults !== 'undefined' && localResults.length > 0))) { %>
        <div class="bg-white p-6 rounded-lg shadow">
          <h3 class="text-xl font-semibold mb-4 border-b pb-2">Profile Image Analysis</h3>
          <div class="prose max-w-none text-gray-700">
            <p><%= imageAnalysis.choices[0].message.content %></p>
          </div>
        </div>
      <% } else if (typeof hasImages !== 'undefined' && !hasImages && typeof localResults !== 'undefined' && localResults.length > 0 && !searchByImage) { %>
        <div class="bg-yellow-50 p-4 rounded-lg border border-yellow-200">
          <h3 class="text-lg font-semibold text-yellow-800 mb-2">Image Analysis</h3>
          <p class="text-yellow-700">No profile images available for analysis in these results.</p>
        </div>
      <% } %>

      <!-- Department Analysis -->
      <% if (typeof departmentImageAnalysis !== 'undefined' && departmentImageAnalysis && (!searchByImage || (typeof localResults !== 'undefined' && localResults.length > 0))) { %>
        <div class="bg-white p-6 rounded-lg shadow">
          <h3 class="text-xl font-semibold mb-4 border-b pb-2">Department Insights</h3>
          <div class="prose max-w-none text-gray-700">
            <% if (departmentImageAnalysis.choices && departmentImageAnalysis.choices.length > 0) { %>
              <p><%= departmentImageAnalysis.choices[0].message.content %></p>
            <% } else { %>
              <p>No department analysis available.</p>
            <% } %>
          </div>
        </div>
      <% } %>

      <!-- Search Again Button for Image Search -->
      <% if (searchByImage) { %>
        <div class="bg-gray-50 p-6 rounded-lg border border-gray-200">
          <h3 class="text-lg font-semibold text-gray-800 mb-3">Search Again</h3>
          <a href="/alumni/search-form" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition-colors font-medium inline-block">
            New Search
          </a>
          <p class="text-sm text-gray-600 mt-2">
            Try a different image or use text search for better results.
          </p>
        </div>
      <% } %>
    </div>
  </div>
</div>
<div class="action-buttons">
  <a href="/alumni/login" class="button">Logout</a>
</div>
<style>
  .prose p {
    margin-bottom: 1rem;
    line-height: 1.6;
  }
  .prose strong {
    font-weight: 600;
    color: #374151;
  }
  .prose em {
    font-style: italic;
    color: #6b7280;
  }
</style>

<script>
  // Enhanced image error handling
  document.addEventListener('DOMContentLoaded', function() {
    const images = document.querySelectorAll('img');
    images.forEach(img => {
      img.addEventListener('error', function() {
        this.style.display = 'none';
        const fallback = this.nextElementSibling;
        if (fallback && fallback.classList.contains('bg-gray-200')) {
          fallback.style.display = 'flex';
        }
      });
      
      img.style.transition = 'opacity 0.3s ease';
      img.style.opacity = '0';
      img.addEventListener('load', function() {
        this.style.opacity = '1';
      });
    });
  });
</script>

<%- include('../../partials/footer') %>
